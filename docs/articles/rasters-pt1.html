<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Rasters Part I: Download, Combine, Subset, and Compute Pixel Summaries • caladaptr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Rasters Part I: Download, Combine, Subset, and Compute Pixel Summaries">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="inverse" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">caladaptr</a>

    <small class="nav-text text-default me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.7.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-home fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/api-requests.html">API Requests</a></li>
    <li><a class="dropdown-item" href="../articles/large-queries.html">Large Queries</a></li>
    <li><a class="dropdown-item" href="../articles/rasters-pt1.html">Rasters Part I: Download, Combine, Subset, and Compute Pixel Summaries</a></li>
    <li><a class="dropdown-item" href="../articles/rasters-pt2.html">Rasters Part II: Six-Dimensional Climate Data Cubes and Spatial Queries</a></li>
    <li><a class="dropdown-item" href="../articles/rasters-pt3.html">Rasters Part III: Downloading Rasters for Large Areas</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-notebooks" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Notebooks</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-notebooks">
<li><a class="dropdown-item" href="https://ucanr-igis.github.io/caladaptr-res/notebooks/caladaptr_intro.nb.html">Introduction</a></li>
    <li><a class="dropdown-item" href="https://ucanr-igis.github.io/caladaptr-res/notebooks/chill.nb.html">Compute Chill</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-shiny-apps" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Shiny Apps</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-shiny-apps">
<li><a class="external-link dropdown-item" href="https://caladaptr.shinyapps.io/timeseries/">Annual Data Time Series</a></li>
    <li><a class="external-link dropdown-item" href="https://ucanr-igis.shinyapps.io/chill/">Projected Chill Hours</a></li>
    <li><a class="external-link dropdown-item" href="https://github.com/ucanr-igis/caladaptr.apps/">caladpatr.apps package</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-videos" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Videos</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-videos">
<li><a class="external-link dropdown-item" href="https://youtu.be/6sDwXPbSYOQ">caladaptR Overview</a></li>
    <li><a class="external-link dropdown-item" href="https://youtu.be/APCIBs35BJg">Code Demo</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-workshops" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Workshops</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-workshops">
<li><a class="dropdown-item" href="https://ucanr-igis.github.io/caladaptr-res/workshops/ca_intro_apr22/">Working with Cal-Adapt Climate Data in R (April 2022)</a></li>
    <li><a class="dropdown-item" href="https://ucanr-igis.github.io/caladaptr-res/workshops/ca_intro_oct21/">Getting Started (Oct 2021)</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ucanr-igis/caladaptr/"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Rasters Part I: Download, Combine, Subset, and Compute Pixel Summaries</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ucanr-igis/caladaptr/blob/master/vignettes/rasters-pt1.Rmd" class="external-link"><code>vignettes/rasters-pt1.Rmd</code></a></small>
      <div class="d-none name"><code>rasters-pt1.Rmd</code></div>
    </div>

    
    
<style type="text/css">
p.indented2 {margin-left:2em;}
</style>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>A great deal of climate data, including the bulk of data from
Cal-Adapt, are inherently raster. The x and y dimensions represent
space, the third dimension represents time, and the values of the
‘cells’ represent a climate variable like maximum temperature.</p>
<p>Raster data can be more challenging to work with than querying values
for a specific location, because the files can be large and you need
special tools to work with them. However if you are working with large
areas, or your analysis calls for something out-of-the-box, then getting
the data as rasters may be the way to go.</p>
<p>There are three commonly used ways to download raster data from
Cal-Adapt:</p>
<ol style="list-style-type: decimal">
<li><p>NetCDF files for the <a href="https://ucanr-igis.github.io/caladaptr-res/images/loca_grid_extent_600x646x256.png">full
extent</a> of the LOCA downscaled data are available for download from
the <a href="http://albers.cnr.berkeley.edu/data/" class="external-link">Cal-Adapt Data
Server</a>. The NetCDF files will be not be discussed further here (but
see Part III).</p></li>
<li><p>Rasters can be downloaded for specific variables and
areas-of-interest using the Cal-Adapt <a href="https://cal-adapt.org/data/download/" class="external-link">Data Download
Tool</a>.</p></li>
<li><p>Rasters can be requested programmatically through the Cal-Adapt
API.</p></li>
</ol>
<p>Downloading rasters is relatively easy with <code>caladaptr</code>.
The same API request object that you use to query values can be used to
download rasters by passing it to <code><a href="../reference/ca_getrst_stars.html">ca_getrst_stars()</a></code>. This
function saves the rasters to disk as TIF files, with additional
‘sidecar’ files that store additional metadata that the TIF format can’t
handle. To do analysis, you next import the TIFs into R with
<code><a href="../reference/ca_stars_read.html">ca_stars_read()</a></code>, where they come in as ‘stars’ objects.
From there, you can use functions from the <a href="https://cran.r-project.org/package=stars" class="external-link">stars</a> package, which
is well-equipped to handle spatiotemporal arrays of raster data.</p>
<p>The rest of this vignette demonstrates how to download and work with
Cal-Adapt data as rasters. Only the first 20% actually involves
functions from caladpatr. The rest of the tutorial, and the bulk of most
work flows, will use functions from stars to combine, subset, and
analyze Cal-Adapt raster data.</p>
</div>
<div class="section level2">
<h2 id="download-practice-data">Download Practice Data<a class="anchor" aria-label="anchor" href="#download-practice-data"></a>
</h2>
<p>To illustrate, we’ll download 20 years of daily temperature data for
Merced County for 4 GCMs and 2 emissions scenarios. Start by loading the
packages we’ll need:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ucanr-igis.github.io/caladaptr">caladaptr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/" class="external-link">stars</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span></code></pre></div>
<p>The FIPs code for Merced County is “06047”<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;To find the FIPS code, you can run
&lt;code&gt;ca_aoipreset_geom("counties", quiet = TRUE) %&amp;gt;% st_drop_geometry() %&amp;gt;% select(name, state_name, fips, id) %&amp;gt;% filter(name == "Merced")&lt;/code&gt;&lt;/p&gt;'><sup>1</sup></a>. As always we first
create an API request:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">merced_cap</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ca_loc_aoipreset.html">ca_loc_aoipreset</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"counties"</span>, idfld <span class="op">=</span> <span class="st">"fips"</span>, idval <span class="op">=</span> <span class="st">"06047"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/ca_gcm.html">ca_gcm</a></span><span class="op">(</span><span class="va">gcms</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/ca_period.html">ca_period</a></span><span class="op">(</span><span class="st">"day"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/ca_cvar.html">ca_cvar</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tasmin"</span>, <span class="st">"tasmax"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/ca_scenario.html">ca_scenario</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rcp45"</span>, <span class="st">"rcp85"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/ca_years.html">ca_years</a></span><span class="op">(</span>start <span class="op">=</span> <span class="fl">2045</span>, end <span class="op">=</span> <span class="fl">2065</span><span class="op">)</span></span></code></pre></div>
<p>Note: normally when you construct an API request object for polygon
features, you’re supposed to include <code><a href="../reference/ca_options.html">ca_options()</a></code> to
specify how you want to spatially aggregate the climate values. This is
optional (and in fact ignored) for downloading rasters, because we are
not spatially aggregating anything. (For an example of spatially
aggregating raster data after it’s been downloaded, see Part III.)</p>
<p>It’s generally a good idea to plot your API request before using it
to ensure you’ve got the right area:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">merced_cap</span>, locagrid <span class="op">=</span> <span class="cn">TRUE</span>, static <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/plot_merced_cap_with_locagrid-1.png" alt="Area of API request with LOCA grid cells"></p>
<p>That all looks good. Next let’s download the data as TIFs by passing
<code>merced_cap</code> to <code><a href="../reference/ca_getrst_stars.html">ca_getrst_stars()</a></code>. This function
does two important things:</p>
<ol style="list-style-type: lower-roman">
<li><p>downloads data and saves them as standard TIFs in
<code>out_dir</code>, and</p></li>
<li><p>creates a little ‘sidecar’ file for each TIF which saves
additional metadata about the TIF (such as the GCM and emissions
scenario).</p></li>
</ol>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_dir</span> <span class="op">&lt;-</span> <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/userdir.html" class="external-link">R_user_dir</a></span><span class="op">(</span><span class="st">"caladaptr"</span>, which <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span></span>
<span><span class="va">merced_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"merced"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">merced_dir</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">merced_dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">merced_stars_fn</span> <span class="op">&lt;-</span> <span class="va">merced_cap</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/ca_getrst_stars.html">ca_getrst_stars</a></span><span class="op">(</span>out_dir <span class="op">=</span> <span class="va">merced_dir</span>, mask <span class="op">=</span> <span class="cn">TRUE</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                  normalize_path <span class="op">=</span> <span class="cn">TRUE</span>, overwrite <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>We can see what was downloaded. Note for each TIF there is a sidecar
rds file with additional metadata:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">merced_dir</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "mercd_bos_dist.geojson"                          "tasmax_day_CanESM2_rcp45_fips-06047.attr.rds"   </span></span>
<span><span class="co">#&gt;  [3] "tasmax_day_CanESM2_rcp45_fips-06047.tif"         "tasmax_day_CanESM2_rcp85_fips-06047.attr.rds"   </span></span>
<span><span class="co">#&gt;  [5] "tasmax_day_CanESM2_rcp85_fips-06047.tif"         "tasmax_day_CNRM-CM5_rcp45_fips-06047.attr.rds"  </span></span>
<span><span class="co">#&gt;  [7] "tasmax_day_CNRM-CM5_rcp45_fips-06047.tif"        "tasmax_day_CNRM-CM5_rcp85_fips-06047.attr.rds"  </span></span>
<span><span class="co">#&gt;  [9] "tasmax_day_CNRM-CM5_rcp85_fips-06047.tif"        "tasmax_day_HadGEM2-ES_rcp45_fips-06047.attr.rds"</span></span>
<span><span class="co">#&gt; [11] "tasmax_day_HadGEM2-ES_rcp45_fips-06047.tif"      "tasmax_day_HadGEM2-ES_rcp85_fips-06047.attr.rds"</span></span>
<span><span class="co">#&gt; [13] "tasmax_day_HadGEM2-ES_rcp85_fips-06047.tif"      "tasmax_day_MIROC5_rcp45_fips-06047.attr.rds"    </span></span>
<span><span class="co">#&gt; [15] "tasmax_day_MIROC5_rcp45_fips-06047.tif"          "tasmax_day_MIROC5_rcp85_fips-06047.attr.rds"    </span></span>
<span><span class="co">#&gt; [17] "tasmax_day_MIROC5_rcp85_fips-06047.tif"          "tasmin_day_CanESM2_rcp45_fips-06047.attr.rds"   </span></span>
<span><span class="co">#&gt; [19] "tasmin_day_CanESM2_rcp45_fips-06047.tif"         "tasmin_day_CanESM2_rcp85_fips-06047.attr.rds"   </span></span>
<span><span class="co">#&gt; [21] "tasmin_day_CanESM2_rcp85_fips-06047.tif"         "tasmin_day_CNRM-CM5_rcp45_fips-06047.attr.rds"  </span></span>
<span><span class="co">#&gt; [23] "tasmin_day_CNRM-CM5_rcp45_fips-06047.tif"        "tasmin_day_CNRM-CM5_rcp85_fips-06047.attr.rds"  </span></span>
<span><span class="co">#&gt; [25] "tasmin_day_CNRM-CM5_rcp85_fips-06047.tif"        "tasmin_day_HadGEM2-ES_rcp45_fips-06047.attr.rds"</span></span>
<span><span class="co">#&gt; [27] "tasmin_day_HadGEM2-ES_rcp45_fips-06047.tif"      "tasmin_day_HadGEM2-ES_rcp85_fips-06047.attr.rds"</span></span>
<span><span class="co">#&gt; [29] "tasmin_day_HadGEM2-ES_rcp85_fips-06047.tif"      "tasmin_day_MIROC5_rcp45_fips-06047.attr.rds"    </span></span>
<span><span class="co">#&gt; [31] "tasmin_day_MIROC5_rcp45_fips-06047.tif"          "tasmin_day_MIROC5_rcp85_fips-06047.attr.rds"    </span></span>
<span><span class="co">#&gt; [33] "tasmin_day_MIROC5_rcp85_fips-06047.tif"</span></span></code></pre></div>
<p><br></p>
<p>Other useful arguments of <code><a href="../reference/ca_getrst_stars.html">ca_getrst_stars()</a></code> include:</p>
<ul>
<li><p>if <code>mask = TRUE</code> and the area of interest is a
polygon, pixels outside the area of interest will be given
<code>NA</code> values</p></li>
<li><p>if there are multiple locations in the API request,
<code>merge_geoms = TRUE</code> will have it merge all the geoms
together and return a single TIF that covers all locations (assuming
they’re not too far apart and the extent of their union is small enough
to be queried by the Cal-Adapt API). See also the vignette on
downloading rasters for large areas.</p></li>
<li><p><code>overwrite = FALSE</code> tells
<code><a href="../reference/ca_getrst_stars.html">ca_getrst_stars()</a></code> to first see if the TIF file has already
been downloaded (based on the automatically generated file name). This
can help you re-run code very quickly because the files won’t have to be
re-downloaded each time.</p></li>
</ul>
<p class="indented2">
<strong>TIP: Managing downloaded TIF files</strong>. There is no way to
import Cal-Adapt data into R as rasters without first downloading TIF
files. To help you manage potentially large numbers of downloaded TIF
files, a good practice is to create separate data directories for each
location or project, and use the <code>out_dir</code> argument to put
the downloaded files where they need to be. If you have no desire to
keep the TIF files, you can download them to <code><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir()</a></code> and
then delete them programatically with <code><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink()</a></code> (remember to
get the rds files also).
</p>
</div>
<div class="section level2">
<h2 id="read-tifs-into-r">Read TIFs into R<a class="anchor" aria-label="anchor" href="#read-tifs-into-r"></a>
</h2>
<p>The object returned by <code><a href="../reference/ca_getrst_stars.html">ca_getrst_stars()</a></code> is a vector of
TIF file names. The easiest and recommended way to work with those
rasters in R is to import the TIFs with <code><a href="../reference/ca_read_stars.html">ca_read_stars()</a></code>.
You can read a whole bunch of TIFs with this function by passing it a
vector of TIF file names. <code><a href="../reference/ca_read_stars.html">ca_read_stars()</a></code> returns a
<strong>list of stars objects</strong> attributed with additional
metadata from Cal-Adapt:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mercd_stars_lst</span> <span class="op">&lt;-</span> <span class="va">merced_stars_fn</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/ca_stars_read.html">ca_stars_read</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">mercd_stars_lst</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "list"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mercd_stars_lst</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 16</span></span></code></pre></div>
<p>Note: stars objects are read into memory by default. If your rasters
are really large, and/or you are getting a lot of climate variables,
there are ways of controlling what gets loaded and when. Passing
<code>proxy = TRUE</code> to <code><a href="../reference/ca_stars_read.html">ca_stars_read()</a></code> will create a
list of ‘stars proxy’ objects, which are just like stars objects but
reading data from disk is postponed until needed. See the <a href="https://r-spatial.github.io/stars/articles/stars2.html" class="external-link">stars
documentation</a> for details.</p>
<p>Let’s look at the elements of our stars list:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mercd_stars_lst</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "tasmin_day_HadGEM2-ES_rcp45_fips-06047" "tasmax_day_HadGEM2-ES_rcp45_fips-06047" "tasmin_day_CNRM-CM5_rcp45_fips-06047"  </span></span>
<span><span class="co">#&gt;  [4] "tasmax_day_CNRM-CM5_rcp45_fips-06047"   "tasmin_day_CanESM2_rcp45_fips-06047"    "tasmax_day_CanESM2_rcp45_fips-06047"   </span></span>
<span><span class="co">#&gt;  [7] "tasmin_day_MIROC5_rcp45_fips-06047"     "tasmax_day_MIROC5_rcp45_fips-06047"     "tasmin_day_HadGEM2-ES_rcp85_fips-06047"</span></span>
<span><span class="co">#&gt; [10] "tasmax_day_HadGEM2-ES_rcp85_fips-06047" "tasmin_day_CNRM-CM5_rcp85_fips-06047"   "tasmax_day_CNRM-CM5_rcp85_fips-06047"  </span></span>
<span><span class="co">#&gt; [13] "tasmin_day_CanESM2_rcp85_fips-06047"    "tasmax_day_CanESM2_rcp85_fips-06047"    "tasmin_day_MIROC5_rcp85_fips-06047"    </span></span>
<span><span class="co">#&gt; [16] "tasmax_day_MIROC5_rcp85_fips-06047"</span></span></code></pre></div>
<p>We can see from the above that our list contains 16 stars objects for
different combos of GCM, emissions scenario, and climate variable.</p>
<p><br></p>
<p>For simplicity, the rest of this vignette will just use one or two of
these stars objects. Normally you’d want to work with all your rasters,
which may involve writing code loops to work through the list of stars
objects. Below we’ll see how to generate an index for your stars objects
to make code loops a little easier. Part II will introduce an even
better way of processing multiple stars objects by combining them into a
single six-dimensional climate data cube.</p>
</div>
<div class="section level2">
<h2 id="explore-a-stars-object">Explore a stars object<a class="anchor" aria-label="anchor" href="#explore-a-stars-object"></a>
</h2>
<p>Let’s look at the properties of the first stars object in our
list:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mercd_stars_lst</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co">#&gt; attribute(s), summary of first 1e+05 cells:</span></span>
<span><span class="co">#&gt;                                     Min.  1st Qu.   Median    Mean  3rd Qu.     Max.  NA's</span></span>
<span><span class="co">#&gt; tasmin_day_HadGEM2-ES_rcp45...  266.4809 280.8343 285.1293 284.897 289.0701 302.3545 58748</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;      from   to     offset   delta refsys point x/y</span></span>
<span><span class="co">#&gt; x       1   20     -121.2  0.0625 WGS 84 FALSE [x]</span></span>
<span><span class="co">#&gt; y       1   16      37.69 -0.0625 WGS 84 FALSE [y]</span></span>
<span><span class="co">#&gt; date    1 7670 2045-01-01  1 days   Date    NA</span></span></code></pre></div>
<p>We see this stars object has 3 dimensions. The first two are columns
(x) and rows (y), and the third one is date.</p>
<p>In general, the layers of rasters downloaded from Cal-Adapt represent
different time periods. In this case, we asked for daily temperature
data, so each of the 7670 layers represents the temperature for one day.
The values of the cells are the minimum daily temperature (tasmin).
There’s another stars object somewhere in our list with the
corresponding daily maximum temperature (tasmax).</p>
<p>Let’s look at the cell values of the first stars object. We can use
[[i]] notation to get the values of the ith attribute of a stars object
(our stars objects only have one attribute so [[1]] works).</p>
<p class="indented2">
<strong>TIP</strong>: if you prefer dplyr functions, you can use
<code>pull(1)</code> instead of the second <code>[[]]</code> to get the
values.
</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mercd_stars_lst</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/mode.html" class="external-link">mode</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "numeric"</span></span>
<span><span class="va">mercd_stars_lst</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's </span></span>
<span><span class="co">#&gt;   263.7   279.6   284.2   284.3   289.1   306.7 1441960</span></span>
<span><span class="co"># mercd_stars_lst[[1]] %&gt;% pull(1) %&gt;% summary()</span></span></code></pre></div>
<ul>
<li><p><code><a href="https://rdrr.io/r/base/mode.html" class="external-link">mode()</a></code> tells us the values of each element (pixel)
are numeric (R’s data type for double precision numbers).</p></li>
<li><p><code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> reports the quantiles. These numbers are
degrees Kelvin, which we would have known by reading the Cal-Adapt
documentation. There are a lot of NA’s because we told it to mask the
data, so any pixel that lies outside the boundary of Merced County will
be full of NAs.</p></li>
</ul>
<p><br></p>
</div>
<div class="section level2">
<h2 id="subsetting-stars-objects">Subsetting stars objects<a class="anchor" aria-label="anchor" href="#subsetting-stars-objects"></a>
</h2>
<p>Before we go any further, we need to talk about subsetting stars
objects. We’ve already been subsetting a list of stars objects using
standard R list notation (e.g., <code>mercd_stars_lst[[1]]</code>). This
helps us grab an individual stars object of interest. But stars objects
can also be subsetted.</p>
<p>It’s helpful to remember that stars objects are essentially lists of
arrays. Those arrays could be two-dimensional, like a traditional
raster, or they could have 3 or more dimensions. We’ve already seen a
3-dimensional stars object, where the third dimension is time.</p>
<p>Subsetting stars objects along their dimensions is a common step in
analysis. Fortunately, the dimensions of stars objects are named (e.g.,
<em>x</em>, <em>y</em>, <em>date</em>). Hence when we subset along
dimensions, we can write filter expressions that use the name of
dimension to make it more readable (e.g.,
<code>date &gt; as.Date("2050-01-01")</code>)</p>
<p>You can subset stars objects the dplyr verbs <code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter()</a></code>
and <code><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice()</a></code>. For example if we just wanted to select 3 rows
and 3 columns, we could pass integers to <code><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice()</a></code>. Note
however we need to tell it which dimensions we’re slicing, using the
<code>along</code> argument:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mercd_stars_lst</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">10</span><span class="op">:</span><span class="fl">12</span>, along <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">7</span><span class="op">:</span><span class="fl">10</span>, along <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span></span>
<span><span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co">#&gt; attribute(s):</span></span>
<span><span class="co">#&gt;                                     Min.  1st Qu.   Median     Mean  3rd Qu.     Max.</span></span>
<span><span class="co">#&gt; tasmin_day_HadGEM2-ES_rcp45...  263.7848 279.8704 284.5147 284.5306 289.4701 300.6826</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;      from   to     offset   delta refsys point x/y</span></span>
<span><span class="co">#&gt; x      10   12     -121.2  0.0625 WGS 84 FALSE [x]</span></span>
<span><span class="co">#&gt; y       7   10      37.69 -0.0625 WGS 84 FALSE [y]</span></span>
<span><span class="co">#&gt; date    1 7670 2045-01-01  1 days   Date    NA</span></span></code></pre></div>
<p><code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter()</a></code> works similarly to <code><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice()</a></code>, but
uses logical values (or more commonly an expression that generates
logical values), rather than indices. If we wanted to further subset our
data to just values in January 2055, we could add a filter
expression:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mercd_stars_lst</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">10</span><span class="op">:</span><span class="fl">12</span>, along <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">7</span><span class="op">:</span><span class="fl">10</span>, along <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2055-01-01"</span><span class="op">)</span>, <span class="va">date</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2055-01-31"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co">#&gt; attribute(s):</span></span>
<span><span class="co">#&gt;                                     Min.  1st Qu.   Median     Mean  3rd Qu.     Max.</span></span>
<span><span class="co">#&gt; tasmin_day_HadGEM2-ES_rcp45...  268.9576 276.7619 279.2449 278.5362 281.6215 284.0545</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;      from to     offset   delta refsys point x/y</span></span>
<span><span class="co">#&gt; x       1  3     -120.7  0.0625 WGS 84 FALSE [x]</span></span>
<span><span class="co">#&gt; y       1  4      37.31 -0.0625 WGS 84 FALSE [y]</span></span>
<span><span class="co">#&gt; date    1 31 2055-01-01  1 days   Date    NA</span></span></code></pre></div>
<p>We will see more example of subsetting with dplyr verbs below. One
caveat of subsetting with dplyr is that it may not work if the stars
object has only one row or column. Part II will show examples of
subsetting with square bracket notation, the alternative to dplyr
verbs.</p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="plotting-stars-objects">Plotting stars objects<a class="anchor" aria-label="anchor" href="#plotting-stars-objects"></a>
</h2>
<p>You would need a big sheet of paper to plot 7670 layers as facets. So
we need to either combine the values (e.g., take the mean for each
pixel), or plot a small number of them.</p>
<p>Let’s plot the first four dates of the first stars object in our
list. But since this raster has 3 dimensions, we have to tell it which
dimension to subsample using the <code>along</code> argument. Each day
will be plotted separately.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mercd_stars_lst</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span>index <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, along <span class="op">=</span> <span class="st">"date"</span><span class="op">)</span>,</span>
<span>     axes <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>     main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attributes.html" class="external-link">attributes</a></span><span class="op">(</span><span class="va">mercd_stars_lst</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">ca_metadata</span><span class="op">$</span><span class="va">slug</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/plot_first_four_dates-1.png" alt="Map of the minimum air temperature for the first 4 dates in the stars object."></p>
<p class="indented2">
<strong>TIP</strong>: If you get an error message saying ‘figure margins
too large’, it means either your plot window is too small (resize it in
RStudio), or the stars object you’re trying to plot has way too many
layers.
</p>
<div class="section level3">
<h3 id="overlay-a-vector-feature">Overlay a vector feature<a class="anchor" aria-label="anchor" href="#overlay-a-vector-feature"></a>
</h3>
<p>Overlaying a vector layer on top of plots reassures us that we have
the right area. Let’s include the county boundary in our plot. First we
get the Merced County boundary using <code><a href="../reference/ca_aoipreset_geom.html">ca_aoipreset_geom()</a></code>,
and make sure its in geographic coordinates (epgs 4326) so we can
overlay it:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mercd_bnd_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ca_aoipreset_geom.html">ca_aoipreset_geom</a></span><span class="op">(</span><span class="st">"counties"</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">fips</span> <span class="op">==</span> <span class="st">"06047"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span></span></code></pre></div>
<p>To plot them together, we’ll use the basic <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>
function, which the stars package has tailored to work with stars
rasters (including automatic resampling). To overlay vector layers using
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>, we have to:</p>
<ol style="list-style-type: lower-roman">
<li><p>add <code>reset = FALSE</code> to the first plot statement (so it
doesn’t reset the axes after drawing the plot, which get a little funky
because of the legend)</p></li>
<li><p>include <code>add = TRUE</code> in all subsequent plot
statements</p></li>
</ol>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mercd_stars_lst</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span>index <span class="op">=</span> <span class="fl">1</span>, along <span class="op">=</span> <span class="st">"date"</span><span class="op">)</span>, axes <span class="op">=</span> <span class="cn">TRUE</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mercd_bnd_sf</span>, border <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, axes <span class="op">=</span> <span class="cn">TRUE</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/plot_mercd_stars_lst-1.png" alt="Plot of the minimum air temperature for the first date overlain with the Merced County boundary"></p>
<p><br></p>
</div>
</div>
<div class="section level2">
<h2 id="create-a-list-index">Create a List Index<a class="anchor" aria-label="anchor" href="#create-a-list-index"></a>
</h2>
<p>At this point we have a list with 16 stars objects. To help us figure
out which is which, we’ll create an index of them using
<code>ca_index_starslist()</code>. This function reads the extra
metadata for each stars object (saved in those sidecare files), and
returns a tibble:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">mercd_stars_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ca_stars_index.html">ca_stars_index</a></span><span class="op">(</span><span class="va">mercd_stars_lst</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 16 × 14</span></span>
<span><span class="co">#&gt;      idx cvar   units scenario gcm        period slug                        livneh start      end        idfld idval  rows  cols</span></span>
<span><span class="co">#&gt;    &lt;int&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;                       &lt;lgl&gt;  &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1     1 tasmin K     rcp45    HadGEM2-ES day    tasmin_day_HadGEM2-ES_rcp45 FALSE  2045-01-01 2065-12-31 fips  06047    20    16</span></span>
<span><span class="co">#&gt;  2     2 tasmax K     rcp45    HadGEM2-ES day    tasmax_day_HadGEM2-ES_rcp45 FALSE  2045-01-01 2065-12-31 fips  06047    20    16</span></span>
<span><span class="co">#&gt;  3     3 tasmin K     rcp45    CNRM-CM5   day    tasmin_day_CNRM-CM5_rcp45   FALSE  2045-01-01 2065-12-31 fips  06047    20    16</span></span>
<span><span class="co">#&gt;  4     4 tasmax K     rcp45    CNRM-CM5   day    tasmax_day_CNRM-CM5_rcp45   FALSE  2045-01-01 2065-12-31 fips  06047    20    16</span></span>
<span><span class="co">#&gt;  5     5 tasmin K     rcp45    CanESM2    day    tasmin_day_CanESM2_rcp45    FALSE  2045-01-01 2065-12-31 fips  06047    20    16</span></span>
<span><span class="co">#&gt;  6     6 tasmax K     rcp45    CanESM2    day    tasmax_day_CanESM2_rcp45    FALSE  2045-01-01 2065-12-31 fips  06047    20    16</span></span>
<span><span class="co">#&gt;  7     7 tasmin K     rcp45    MIROC5     day    tasmin_day_MIROC5_rcp45     FALSE  2045-01-01 2065-12-31 fips  06047    20    16</span></span>
<span><span class="co">#&gt;  8     8 tasmax K     rcp45    MIROC5     day    tasmax_day_MIROC5_rcp45     FALSE  2045-01-01 2065-12-31 fips  06047    20    16</span></span>
<span><span class="co">#&gt;  9     9 tasmin K     rcp85    HadGEM2-ES day    tasmin_day_HadGEM2-ES_rcp85 FALSE  2045-01-01 2065-12-31 fips  06047    20    16</span></span>
<span><span class="co">#&gt; 10    10 tasmax K     rcp85    HadGEM2-ES day    tasmax_day_HadGEM2-ES_rcp85 FALSE  2045-01-01 2065-12-31 fips  06047    20    16</span></span>
<span><span class="co">#&gt; 11    11 tasmin K     rcp85    CNRM-CM5   day    tasmin_day_CNRM-CM5_rcp85   FALSE  2045-01-01 2065-12-31 fips  06047    20    16</span></span>
<span><span class="co">#&gt; 12    12 tasmax K     rcp85    CNRM-CM5   day    tasmax_day_CNRM-CM5_rcp85   FALSE  2045-01-01 2065-12-31 fips  06047    20    16</span></span>
<span><span class="co">#&gt; 13    13 tasmin K     rcp85    CanESM2    day    tasmin_day_CanESM2_rcp85    FALSE  2045-01-01 2065-12-31 fips  06047    20    16</span></span>
<span><span class="co">#&gt; 14    14 tasmax K     rcp85    CanESM2    day    tasmax_day_CanESM2_rcp85    FALSE  2045-01-01 2065-12-31 fips  06047    20    16</span></span>
<span><span class="co">#&gt; 15    15 tasmin K     rcp85    MIROC5     day    tasmin_day_MIROC5_rcp85     FALSE  2045-01-01 2065-12-31 fips  06047    20    16</span></span>
<span><span class="co">#&gt; 16    16 tasmax K     rcp85    MIROC5     day    tasmax_day_MIROC5_rcp85     FALSE  2045-01-01 2065-12-31 fips  06047    20    16</span></span></code></pre></div>
<div class="section level3">
<h3 id="subset-the-list-by-gcm-emissions-scenario">Subset the list by GCM &amp; emissions scenario<a class="anchor" aria-label="anchor" href="#subset-the-list-by-gcm-emissions-scenario"></a>
</h3>
<p>To simplify things, we’ll only work with temperature data for one GCM
and one emissions scenario. We can use our index tibble to extract the
indices of the elements of our list that use the same GCM and
scenario:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">lst_idx</span> <span class="op">&lt;-</span> <span class="va">mercd_stars_tbl</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">gcm</span> <span class="op">==</span> <span class="st">"HadGEM2-ES"</span>, <span class="va">scenario</span> <span class="op">==</span> <span class="st">"rcp45"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">idx</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1 2</span></span></code></pre></div>
<p>Now we can create a list of stars objects that use this GCM and
emissions scenario. At this point, we’re still just working with a
regular list.</p>
<p>We’ll subset the list using <code><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">extract()</a></code> (magrittr package)
which is the equivalent of subsetting a list with [].</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">one_gcm_scen_lst</span> <span class="op">&lt;-</span> <span class="va">mercd_stars_lst</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">lst_idx</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">one_gcm_scen_lst</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "list"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">one_gcm_scen_lst</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "tasmin_day_HadGEM2-ES_rcp45_fips-06047" "tasmax_day_HadGEM2-ES_rcp45_fips-06047"</span></span></code></pre></div>
<p>We now have a list with two stars objects. The two stars objects have
the same spatial area, dates, GCM and emission scenario. But one is
<code>tasmin</code> and the other is <code>tasmax</code>. Our goal is to
compute growing degree days, which is computed by
<code>(tasmin + tasmax / 2) - basetemp</code>. So we need to get
<code>tasmin</code> and <code>tasmax</code> in the same stars object as
a new dimension we’ll call ‘cvar’.</p>
<p>To get them into a single stars object, we’ll ‘merge’ them together
using <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code>. The stars package provides a special version of
<code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code> which has been adapted for combining stars objects. The
stars <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code> has an optional ‘along’ argument, which is how we
tell it that we want the values from the two stars objects to be turned
into another dimension (as opposed to a 2nd attribute).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">one_gcm_scen_lst</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">one_gcm_scen_lst</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, along <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cvar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tasmin"</span>, <span class="st">"tasmax"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; stars object with 4 dimensions and 1 attribute</span></span>
<span><span class="co">#&gt; attribute(s), summary of first 1e+05 cells:</span></span>
<span><span class="co">#&gt;                                     Min.  1st Qu.   Median    Mean  3rd Qu.     Max.  NA's</span></span>
<span><span class="co">#&gt; tasmin_day_HadGEM2-ES_rcp45...  266.4809 280.8343 285.1293 284.897 289.0701 302.3545 58748</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;      from   to     offset   delta refsys point         values x/y</span></span>
<span><span class="co">#&gt; x       1   20     -121.2  0.0625 WGS 84 FALSE           NULL [x]</span></span>
<span><span class="co">#&gt; y       1   16      37.69 -0.0625 WGS 84 FALSE           NULL [y]</span></span>
<span><span class="co">#&gt; date    1 7670 2045-01-01  1 days   Date    NA           NULL    </span></span>
<span><span class="co">#&gt; cvar    1    2         NA      NA     NA    NA tasmin, tasmax</span></span></code></pre></div>
<p>Note the appearance of a new attribute with two values.</p>
<p>That does the job, but we can do better. In the next chunk we’ll
modify the above by:</p>
<ul>
<li>calling <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code> as part of a <code>do.call</code> (which is
programmatically more flexible)</li>
<li>programatically create the values for the new dimension, which we
pass as named list to <code>along</code>
</li>
<li>tack on <code><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames()</a></code> at the end to rename the attribute
to something easier on the eye</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Get the names of the climate variables in these two stars objects from the index tibble</span></span>
<span><span class="op">(</span><span class="va">cvars_these_two</span> <span class="op">&lt;-</span> <span class="va">mercd_stars_tbl</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="va">lst_idx</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">cvar</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "tasmin" "tasmax"</span></span>
<span></span>
<span><span class="co">## Combine the two stars objects into one</span></span>
<span><span class="op">(</span><span class="va">tasmin_tasmax_combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">c</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">one_gcm_scen_lst</span>,</span>
<span>                                    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>along <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cvar <span class="op">=</span> <span class="va">cvars_these_two</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="st">"val"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; stars object with 4 dimensions and 1 attribute</span></span>
<span><span class="co">#&gt; attribute(s), summary of first 1e+05 cells:</span></span>
<span><span class="co">#&gt;          Min.  1st Qu.   Median    Mean  3rd Qu.     Max.  NA's</span></span>
<span><span class="co">#&gt; val  266.4809 280.8343 285.1293 284.897 289.0701 302.3545 58748</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;      from   to     offset   delta refsys point         values x/y</span></span>
<span><span class="co">#&gt; x       1   20     -121.2  0.0625 WGS 84 FALSE           NULL [x]</span></span>
<span><span class="co">#&gt; y       1   16      37.69 -0.0625 WGS 84 FALSE           NULL [y]</span></span>
<span><span class="co">#&gt; date    1 7670 2045-01-01  1 days   Date    NA           NULL    </span></span>
<span><span class="co">#&gt; cvar    1    2         NA      NA     NA    NA tasmin, tasmax</span></span></code></pre></div>
<p><br></p>
</div>
</div>
<div class="section level2">
<h2 id="time-filters">Time Filters<a class="anchor" aria-label="anchor" href="#time-filters"></a>
</h2>
<div class="section level3">
<h3 id="date-filter">Date Filter<a class="anchor" aria-label="anchor" href="#date-filter"></a>
</h3>
<p>To filter by date, we can write a filter expression that references
the ‘date’ dimension. The following will return just days between March
15 and April 14, 2050 (which you can verify by looking at the range of
the date dimension).</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tasmin_tasmax_combined</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2050-03-15"</span><span class="op">)</span>, <span class="va">date</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2050-04-14"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; stars object with 4 dimensions and 1 attribute</span></span>
<span><span class="co">#&gt; attribute(s):</span></span>
<span><span class="co">#&gt;          Min. 1st Qu.   Median    Mean  3rd Qu.     Max.  NA's</span></span>
<span><span class="co">#&gt; val  270.9343 278.897 284.9836 287.165 295.5038 303.8904 11656</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;      from to     offset   delta refsys point         values x/y</span></span>
<span><span class="co">#&gt; x       1 20     -121.2  0.0625 WGS 84 FALSE           NULL [x]</span></span>
<span><span class="co">#&gt; y       1 16      37.69 -0.0625 WGS 84 FALSE           NULL [y]</span></span>
<span><span class="co">#&gt; date    1 31 2050-03-15  1 days   Date    NA           NULL    </span></span>
<span><span class="co">#&gt; cvar    1  2         NA      NA     NA    NA tasmin, tasmax</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="month-filter">Month Filter<a class="anchor" aria-label="anchor" href="#month-filter"></a>
</h3>
<p>In a similar fashion, we can use <code><a href="https://lubridate.tidyverse.org/reference/month.html" class="external-link">lubridate::month()</a></code> to
just get the days in March:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">tasmin_tasmax_march</span> <span class="op">&lt;-</span> <span class="va">tasmin_tasmax_combined</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html" class="external-link">month</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; stars object with 4 dimensions and 1 attribute</span></span>
<span><span class="co">#&gt; attribute(s):</span></span>
<span><span class="co">#&gt;          Min.  1st Qu.   Median     Mean  3rd Qu.     Max.   NA's</span></span>
<span><span class="co">#&gt; val  267.8101 280.1277 286.4186 287.2461 294.2314 308.7601 244776</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;      from  to offset   delta refsys point                    values x/y</span></span>
<span><span class="co">#&gt; x       1  20 -121.2  0.0625 WGS 84 FALSE                      NULL [x]</span></span>
<span><span class="co">#&gt; y       1  16  37.69 -0.0625 WGS 84 FALSE                      NULL [y]</span></span>
<span><span class="co">#&gt; date    1 651     NA      NA   Date    NA 2045-03-01,...,2065-03-31    </span></span>
<span><span class="co">#&gt; cvar    1   2     NA      NA     NA    NA            tasmin, tasmax</span></span></code></pre></div>
<p>Note how the result includes the actual date values for the dimension
fields (which is critical actually because they’re not regularly
spaced). We can visually verify we only got March values by looking at a
random sample of the date values. <code><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html" class="external-link">st_get_dimension_values()</a></code>
return the values for a dimension:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html" class="external-link">st_get_dimension_values</a></span><span class="op">(</span><span class="va">tasmin_tasmax_march</span>, which <span class="op">=</span> <span class="st">"date"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "2047-03-28" "2062-03-20" "2058-03-27" "2052-03-31" "2045-03-21" "2059-03-05" "2046-03-13" "2061-03-16" "2061-03-22" "2063-03-20"</span></span>
<span><span class="co">#&gt; [11] "2056-03-30" "2055-03-13" "2057-03-22" "2063-03-22" "2063-03-01" "2050-03-10" "2052-03-04" "2049-03-24" "2046-03-28" "2065-03-08"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="julian-day-filter">Julian Day Filter<a class="anchor" aria-label="anchor" href="#julian-day-filter"></a>
</h3>
<p>We can also filter on the day-of-the-year (Julian day). First get the
Julian day for the start and end dates using
<code><a href="https://lubridate.tidyverse.org/reference/day.html" class="external-link">lubridate::yday()</a></code>:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">jday_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html" class="external-link">yday</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-04-15"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 105</span></span>
<span><span class="op">(</span><span class="va">jday_end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html" class="external-link">yday</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-10-01"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 274</span></span></code></pre></div>
<p>Filter our daily temperature stars object using these Julian
dates:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">tasmin_tasmax_ag_season</span> <span class="op">&lt;-</span>  <span class="va">tasmin_tasmax_combined</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html" class="external-link">yday</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">jday_start</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html" class="external-link">yday</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="va">jday_end</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; stars object with 4 dimensions and 1 attribute</span></span>
<span><span class="co">#&gt; attribute(s), summary of first 1e+05 cells:</span></span>
<span><span class="co">#&gt;          Min.  1st Qu.   Median     Mean 3rd Qu.     Max.  NA's</span></span>
<span><span class="co">#&gt; val  274.1193 285.6643 288.6104 288.2912  291.05 302.3545 58748</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;      from   to offset   delta refsys point                    values x/y</span></span>
<span><span class="co">#&gt; x       1   20 -121.2  0.0625 WGS 84 FALSE                      NULL [x]</span></span>
<span><span class="co">#&gt; y       1   16  37.69 -0.0625 WGS 84 FALSE                      NULL [y]</span></span>
<span><span class="co">#&gt; date    1 3570     NA      NA   Date    NA 2045-04-15,...,2065-10-01    </span></span>
<span><span class="co">#&gt; cvar    1    2     NA      NA     NA    NA            tasmin, tasmax</span></span></code></pre></div>
<p>To verify, let’s look at the first few values of the date
dimension:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tasmin_tasmax_ag_season</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html" class="external-link">st_get_dimension_values</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2045-04-15" "2045-04-16" "2045-04-17" "2045-04-18" "2045-04-19" "2045-04-20"</span></span></code></pre></div>
<p><br></p>
</div>
</div>
<div class="section level2">
<h2 id="compute-gdd">Compute GDD<a class="anchor" aria-label="anchor" href="#compute-gdd"></a>
</h2>
<p>Bringing this all together, we’ll next compute growing degree days
(GDD) for one season, one GCM, and one emission scenario. Accumulated
GDD is commonly used in agriculture to predict when tree crops will be
ready to harvest (amongst other things). The are many flavors of GDD but
we’ll use a basic formula:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mi>D</mi><mi>D</mi><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mi>a</mi><mi>s</mi><mi>m</mi><mi>i</mi><mi>n</mi><mo>+</mo><mi>t</mi><mi>a</mi><mi>s</mi><mi>m</mi><mi>a</mi><mi>x</mi><mi>/</mi><mn>2</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mi>b</mi><mi>a</mi><mi>s</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>m</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">GDD = (tasmin + tasmax / 2) - basetemp</annotation></semantics></math></p>
<p>Where <em>basetemp</em> is crop-specific (we’ll use 7 degree Celsius
which is the base temperature for Pistachios).</p>
<div class="section level3">
<h3 id="prepare-one-season-of-daily-minmax-in-celsius">Prepare one season of daily min/max in Celsius<a class="anchor" aria-label="anchor" href="#prepare-one-season-of-daily-minmax-in-celsius"></a>
</h3>
<p>First, let’s filter <code>tasmin_tasmax_combined</code> down to one
growing season starting from mid-April (roughly when Pistachio bloom
occurs):</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">season_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2050-04-15"</span><span class="op">)</span></span>
<span><span class="va">season_end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2050-09-30"</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">one_season_kelvin</span> <span class="op">&lt;-</span> <span class="va">tasmin_tasmax_combined</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&gt;=</span> <span class="va">season_start</span>, <span class="va">date</span> <span class="op">&lt;=</span> <span class="va">season_end</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; stars object with 4 dimensions and 1 attribute</span></span>
<span><span class="co">#&gt; attribute(s):</span></span>
<span><span class="co">#&gt;          Min. 1st Qu.   Median     Mean  3rd Qu.     Max.  NA's</span></span>
<span><span class="co">#&gt; val  274.7148 288.101 295.9296 297.4148 307.0851 317.9881 63544</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;      from  to     offset   delta refsys point         values x/y</span></span>
<span><span class="co">#&gt; x       1  20     -121.2  0.0625 WGS 84 FALSE           NULL [x]</span></span>
<span><span class="co">#&gt; y       1  16      37.69 -0.0625 WGS 84 FALSE           NULL [y]</span></span>
<span><span class="co">#&gt; date    1 169 2050-04-15  1 days   Date    NA           NULL    </span></span>
<span><span class="co">#&gt; cvar    1   2         NA      NA     NA    NA tasmin, tasmax</span></span></code></pre></div>
<p>We need to convert the values from Kelvin to Celsius, which we can do
by making a copy and then subtracting 273 from the first array:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">one_season_c</span> <span class="op">&lt;-</span> <span class="va">one_season_kelvin</span></span>
<span><span class="va">one_season_c</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">one_season_c</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">-</span> <span class="fl">273.15</span></span>
<span><span class="va">one_season_c</span></span>
<span><span class="co">#&gt; stars object with 4 dimensions and 1 attribute</span></span>
<span><span class="co">#&gt; attribute(s):</span></span>
<span><span class="co">#&gt;          Min.  1st Qu.   Median     Mean  3rd Qu.    Max.  NA's</span></span>
<span><span class="co">#&gt; val  1.564752 14.95095 22.77963 24.26485 33.93511 44.8381 63544</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;      from  to     offset   delta refsys point         values x/y</span></span>
<span><span class="co">#&gt; x       1  20     -121.2  0.0625 WGS 84 FALSE           NULL [x]</span></span>
<span><span class="co">#&gt; y       1  16      37.69 -0.0625 WGS 84 FALSE           NULL [y]</span></span>
<span><span class="co">#&gt; date    1 169 2050-04-15  1 days   Date    NA           NULL    </span></span>
<span><span class="co">#&gt; cvar    1   2         NA      NA     NA    NA tasmin, tasmax</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="compute-daily-gdd">Compute Daily GDD<a class="anchor" aria-label="anchor" href="#compute-daily-gdd"></a>
</h3>
<p>Now we can compute GDD. We start by writing the function that takes
an argument x, which will be numeric vector of length 2 containing the
min and max temp for a day, plus the basetemp.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gdd_daily</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">basetemp</span><span class="op">)</span> <span class="op">{</span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="va">basetemp</span><span class="op">}</span></span></code></pre></div>
<p>Caveat: this simple GDD function doesn’t check for negative GDD.
Negative GDD values are generally changed to 0 because plant and insect
growth generally do not go backwards.</p>
<p>We call our custom function in <code><a href="https://r-spatial.github.io/stars/reference/st_apply.html" class="external-link">st_apply()</a></code>. Our function
will be called for each element of the dimensions we loop over given in
MARGIN. Below, we’re looping over x, y, and date. That leaves cvar, a
dimension which has a range of two. This means our GDD function will
receive a numeric vector of length two (min and max temp). The character
value passed with <code>.fname</code> will become the name of the new
attribute.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">one_season_gdd_dly</span> <span class="op">&lt;-</span> <span class="va">one_season_c</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_apply.html" class="external-link">st_apply</a></span><span class="op">(</span>MARGIN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"date"</span><span class="op">)</span>, FUN <span class="op">=</span> <span class="va">gdd_daily</span>, basetemp <span class="op">=</span> <span class="fl">7</span>, .fname <span class="op">=</span> <span class="st">"gdd_dly"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co">#&gt; attribute(s):</span></span>
<span><span class="co">#&gt;              Min. 1st Qu.   Median     Mean  3rd Qu.     Max.  NA's</span></span>
<span><span class="co">#&gt; gdd_dly  4.349542 14.2549 17.41654 17.26485 20.50904 27.19601 31772</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;      from  to     offset   delta refsys point x/y</span></span>
<span><span class="co">#&gt; x       1  20     -121.2  0.0625 WGS 84 FALSE [x]</span></span>
<span><span class="co">#&gt; y       1  16      37.69 -0.0625 WGS 84 FALSE [y]</span></span>
<span><span class="co">#&gt; date    1 169 2050-04-15  1 days   Date    NA</span></span></code></pre></div>
<p class="indented2">
<strong>TIP</strong>: An alternative way of writing our GDD function is
to make separate arguments for tasmin and tasmax. This can be a <a href="https://r-spatial.github.io/stars/reference/st_apply.html#details" class="external-link">lot
faster</a> (4x as fast in this case). Separating the arguments is viable
in this case because we know that exactly two values will be passed to
the function. If we were passing a big array of values it wouldn’t
possible. If your aggregation function expects the input array elements
as separate arguments, you also have to add
<code>single_arg = FALSE</code> to <code><a href="https://r-spatial.github.io/stars/reference/st_apply.html" class="external-link">st_apply()</a></code>. Example:
</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gdd_daily_2args</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span>, <span class="va">basetemp</span><span class="op">)</span> <span class="op">{</span><span class="op">(</span><span class="op">(</span><span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="va">basetemp</span><span class="op">}</span></span>
<span></span>
<span><span class="op">(</span><span class="va">one_season_c</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_apply.html" class="external-link">st_apply</a></span><span class="op">(</span>MARGIN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"date"</span><span class="op">)</span>,</span>
<span>                           FUN <span class="op">=</span> <span class="va">gdd_daily_2args</span>, basetemp <span class="op">=</span> <span class="fl">7</span>,</span>
<span>                           .fname <span class="op">=</span> <span class="st">"gdd"</span>, single_arg <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co">#&gt; attribute(s):</span></span>
<span><span class="co">#&gt;          Min. 1st Qu.   Median     Mean  3rd Qu.     Max.  NA's</span></span>
<span><span class="co">#&gt; gdd  4.349542 14.2549 17.41654 17.26485 20.50904 27.19601 31772</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;      from  to     offset   delta refsys point x/y</span></span>
<span><span class="co">#&gt; x       1  20     -121.2  0.0625 WGS 84 FALSE [x]</span></span>
<span><span class="co">#&gt; y       1  16      37.69 -0.0625 WGS 84 FALSE [y]</span></span>
<span><span class="co">#&gt; date    1 169 2050-04-15  1 days   Date    NA</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="explore-results">Explore results<a class="anchor" aria-label="anchor" href="#explore-results"></a>
</h3>
<p>Let’s drill down and get the GDD values for a point in the center of
the county:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">mercd_ctr_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="va">mercd_bnd_sf</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Geometry set for 1 feature </span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -120.7186 ymin: 37.19131 xmax: -120.7186 ymax: 37.19131</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="co">#&gt; POINT (-120.7186 37.19131)</span></span></code></pre></div>
<p>Get the values at that location using <code><a href="https://r-spatial.github.io/stars/reference/st_extract.html" class="external-link">st_extract()</a></code>:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">gdd_ctr_stars</span> <span class="op">&lt;-</span> <span class="va">one_season_gdd_dly</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_extract.html" class="external-link">st_extract</a></span><span class="op">(</span><span class="va">mercd_ctr_sf</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; stars object with 2 dimensions and 1 attribute</span></span>
<span><span class="co">#&gt; attribute(s):</span></span>
<span><span class="co">#&gt;              Min.  1st Qu.   Median     Mean  3rd Qu.     Max.</span></span>
<span><span class="co">#&gt; gdd_dly  9.925531 15.15791 18.35623 18.03055 20.98876 26.69079</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;          from  to     offset  delta refsys point               values</span></span>
<span><span class="co">#&gt; geometry    1   1         NA     NA WGS 84  TRUE POINT (-120.7 37.19)</span></span>
<span><span class="co">#&gt; date        1 169 2050-04-15 1 days   Date    NA                 NULL</span></span></code></pre></div>
<p>Look closely at the results. <code><a href="https://r-spatial.github.io/stars/reference/st_extract.html" class="external-link">st_extract()</a></code> returned an
array where the first dimension represents not x values (i.e., columns
in a raster), but vector features (in this case points). Dimension two
(usually is reserved for ‘y’) now represents dates, and the values of
the elements represent the daily GDD. There is no 3rd dimension. Hence
when we pull out the array with [[ ]] we should expect a two-dimensional
array where the rows represent features, the columns represent days, and
the values to represent GDD:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">gdd_ctr_stars</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;      date </span></span>
<span><span class="co">#&gt;    1  169</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">gdd_ctr_stars</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;   9.926  15.158  18.356  18.031  20.989  26.691</span></span></code></pre></div>
<p>Using our knowledge of how the results of <code><a href="https://r-spatial.github.io/stars/reference/st_extract.html" class="external-link">st_extract()</a></code>
are structured, we can make a scatter plot of the daily GDD over
time:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gdd_ctr_dates</span> <span class="op">&lt;-</span> <span class="va">gdd_ctr_stars</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html" class="external-link">st_get_dimension_values</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">gdd_ctr_dates</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Date[1:169], format: "2050-04-15" "2050-04-16" "2050-04-17" "2050-04-18" "2050-04-19" "2050-04-20" "2050-04-21" "2050-04-22" "2050-04-23" "2050-04-24" ...</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>date <span class="op">=</span> <span class="va">gdd_ctr_dates</span>, daily_gdd <span class="op">=</span> <span class="va">gdd_ctr_stars</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">daily_gdd</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Projected Daily GDD at the Centroid of Merced County, 2050"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"Simple average method. Base temp: 7 C. GCM: HadGEM2-ES. Scenario: RCP45."</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/plot_daily_gdd_merced_ctr-1.png" alt="Line plot of Projected Daily GDD at the Centroid of Merced County for Apr-Sep 2050"></p>
</div>
<div class="section level3">
<h3 id="accumulated-gdd">Accumulated GDD<a class="anchor" aria-label="anchor" href="#accumulated-gdd"></a>
</h3>
<p>Next, we compute the accumulated GDD by looping over x and y, and
passing the remaining dimensions (in this case 169 values of daily GDD)
to <code><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum()</a></code>. For each pixel, we’ll get back 169 values that
will be placed in a new dimension we’ll call ‘date’. While we’re at it
we can also set the name of the attribute (values) to ‘gdd_csum’.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">one_season_gdd_csum</span> <span class="op">&lt;-</span> <span class="va">one_season_gdd_dly</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_apply.html" class="external-link">st_apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="va">cumsum</span>, .fname <span class="op">=</span> <span class="st">"date"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="st">"gdd_csum"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">one_season_gdd_csum</span></span>
<span><span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co">#&gt; attribute(s):</span></span>
<span><span class="co">#&gt;               Min. 1st Qu.   Median    Mean  3rd Qu.     Max.  NA's</span></span>
<span><span class="co">#&gt; gdd_csum  6.511469 548.138 1285.735 1365.29 2152.067 3102.194 31772</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;      from  to offset   delta refsys point x/y</span></span>
<span><span class="co">#&gt; date    1 169     NA      NA     NA    NA    </span></span>
<span><span class="co">#&gt; x       1  20 -121.2  0.0625 WGS 84 FALSE [x]</span></span>
<span><span class="co">#&gt; y       1  16  37.69 -0.0625 WGS 84 FALSE [y]</span></span></code></pre></div>
<p>This worked but we lost the properties of the new dimension that was
returned by <code><a href="https://r-spatial.github.io/stars/reference/st_apply.html" class="external-link">st_apply()</a></code>. We know the new dimension still
represents the original dates, so we can copy over the the ‘date’
dimension from <code>one_season_gdd_dly</code>:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html" class="external-link">st_dimensions</a></span><span class="op">(</span><span class="va">one_season_gdd_csum</span><span class="op">)</span><span class="op">$</span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html" class="external-link">st_dimensions</a></span><span class="op">(</span><span class="va">one_season_gdd_dly</span><span class="op">)</span><span class="op">$</span><span class="va">date</span></span>
<span><span class="va">one_season_gdd_csum</span></span>
<span><span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co">#&gt; attribute(s):</span></span>
<span><span class="co">#&gt;               Min. 1st Qu.   Median    Mean  3rd Qu.     Max.  NA's</span></span>
<span><span class="co">#&gt; gdd_csum  6.511469 548.138 1285.735 1365.29 2152.067 3102.194 31772</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;      from  to     offset   delta refsys point x/y</span></span>
<span><span class="co">#&gt; date    1 169 2050-04-15  1 days   Date    NA    </span></span>
<span><span class="co">#&gt; x       1  20     -121.2  0.0625 WGS 84 FALSE [x]</span></span>
<span><span class="co">#&gt; y       1  16      37.69 -0.0625 WGS 84 FALSE [y]</span></span></code></pre></div>
<p>To verify, we can get the values for one pixel and plot them:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">one_pt_gddcsum</span> <span class="op">&lt;-</span> <span class="va">one_season_gdd_csum</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">10</span>, along <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">8</span>, along <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">gdd_csum</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="va">one_season_gdd_csum</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html" class="external-link">st_get_dimension_values</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span>,</span>
<span>                  gdd_csum <span class="op">=</span> <span class="va">one_pt_gddcsum</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dt</span>, y <span class="op">=</span> <span class="va">gdd_csum</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/one_season_gdd_csum_pull-1.png" alt="Plot of one season of accumulated growing degree days"></p>
<p>That looks right!</p>
</div>
<div class="section level3">
<h3 id="plot-a-accumulated-gdd-surface">Plot a Accumulated GDD Surface<a class="anchor" aria-label="anchor" href="#plot-a-accumulated-gdd-surface"></a>
</h3>
<p>Plot what GDD looks like on July 15, 2050:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">one_season_gdd_csum</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2050-07-15"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Projected Accumulated GDD July 15, 2050"</span>,</span>
<span>     reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">## Add some details about the data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html" class="external-link">text</a></span><span class="op">(</span><span class="op">-</span><span class="fl">121.2600</span>, <span class="fl">37.61369</span>, <span class="st">"GDD start: April 15, 2050\nGCM: HadGEM2-ES\nScenario: RCP45\nBasetemp: 7 C"</span>, adj <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/one_season_gdd_csum_plot-1.png" alt="Map of Projected Accumulated GDD for Merced County for July 15, 2050"></p>
<p><br></p>
</div>
</div>
<div class="section level2">
<h2 id="save-to-disk">Save to disk<a class="anchor" aria-label="anchor" href="#save-to-disk"></a>
</h2>
<p>You can save stars objects as TIF files with
<code><a href="https://r-spatial.github.io/stars/reference/write_stars.html" class="external-link">write_stars()</a></code>:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tif_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"merced_2050_cum-gdd-base7.tif"</span><span class="op">)</span></span>
<span><span class="co"># write_stars(one_season_gdd_csum, dsn = tif_fn)</span></span></code></pre></div>
<p>Note however that TIF files are limited to 3-dimensional rasters (x,
y, and layers), and in general you can’t save the properties of the
layers, such as the date value (this is precisely why
<code><a href="../reference/ca_getrst_stars.html">ca_getrst_stars()</a></code> writes sidecar files when downloading the
TIFs).</p>
<p>An alternative to saving your stars objects as TIFs would be to save
it as a regular R object using <code><a href="https://rdrr.io/r/base/save.html" class="external-link">save()</a></code> or
<code><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS()</a></code>. This will record the stars object completely,
with the limitation that these formats are only useful for bring the
objects back into R. You could also simply save your code and recreate
the stars objects on the fly by re-importing the TIF files you
downloaded from Cal-Adapt.</p>
<p>netCDF is a much better file format for multidimensional
spatiotemporal arrays. The stars package is not equipped to directly
save stars objects to netCDF (but help may be <a href="https://github.com/r-spatial/stars/issues/419" class="external-link">on the
way</a>).</p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="how-many-frost-days-per-year">How many frost days per year?<a class="anchor" aria-label="anchor" href="#how-many-frost-days-per-year"></a>
</h2>
<p>Next, let’s count up number of frost days, which we’ll approximate as
a day when the minimum temperature is &lt;= 0 °C (for a more robust way
to measure frost exposure, see <a href="https://doi.org/10.1016/j.scitotenv.2020.143971" class="external-link">Parker et al
2020</a>).</p>
<p>This task doesn’t require doing anything fancy with stars. We already
have the projected minimum daily temperature for every pixel in Merced
County for 20 years. We just have to check when it is below 0. However
we’ll have to get a little creative in extracting information from our
stars object, so we wind up with a summary of the number of frozen
pixels per year.</p>
<p>First we make a copy of the first stars object (which records tasmin)
from our list:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">tmin_allyrs_stars</span> <span class="op">&lt;-</span> <span class="va">mercd_stars_lst</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co">#&gt; attribute(s), summary of first 1e+05 cells:</span></span>
<span><span class="co">#&gt;                                     Min.  1st Qu.   Median    Mean  3rd Qu.     Max.  NA's</span></span>
<span><span class="co">#&gt; tasmin_day_HadGEM2-ES_rcp45...  266.4809 280.8343 285.1293 284.897 289.0701 302.3545 58748</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;      from   to     offset   delta refsys point x/y</span></span>
<span><span class="co">#&gt; x       1   20     -121.2  0.0625 WGS 84 FALSE [x]</span></span>
<span><span class="co">#&gt; y       1   16      37.69 -0.0625 WGS 84 FALSE [y]</span></span>
<span><span class="co">#&gt; date    1 7670 2045-01-01  1 days   Date    NA</span></span></code></pre></div>
<p>Identifying which pixels fall below freezing is the easy part. The
following will take the minimum daily temperature arrays and them into
TRUE if the temperature is below 273 (equivalent to 0 °C), otherwise
FALSE:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">frost_allyrs_stars</span> <span class="op">&lt;-</span> <span class="va">tmin_allyrs_stars</span> <span class="op">&lt;=</span> <span class="fl">273</span><span class="op">)</span></span>
<span><span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co">#&gt; attribute(s), summary of first 1e+05 cells:</span></span>
<span><span class="co">#&gt;  tasmin_day_HadGEM2-ES_rcp45... </span></span>
<span><span class="co">#&gt;  Mode :logical                  </span></span>
<span><span class="co">#&gt;  FALSE:40233                    </span></span>
<span><span class="co">#&gt;  TRUE :1019                     </span></span>
<span><span class="co">#&gt;  NA's :58748                    </span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;      from   to     offset   delta refsys point x/y</span></span>
<span><span class="co">#&gt; x       1   20     -121.2  0.0625 WGS 84 FALSE [x]</span></span>
<span><span class="co">#&gt; y       1   16      37.69 -0.0625 WGS 84 FALSE [y]</span></span>
<span><span class="co">#&gt; date    1 7670 2045-01-01  1 days   Date    NA</span></span></code></pre></div>
<p>Finding the total number of pixels-days below freezing is also pretty
easy. We simply grab all the TRUE/FALSE values with <code>pull(1)</code>
(or <code>[[1]]</code>), and sum them up. When you add up TRUE/FALSE
values, the TRUEs become 1 and the FALSEs become 0. Or we can feed them
into <code><a href="https://rdrr.io/r/base/table.html" class="external-link">table()</a></code>:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">frost_allyrs_stars</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; .</span></span>
<span><span class="co">#&gt;  FALSE   TRUE </span></span>
<span><span class="co">#&gt; 985914  26526</span></span></code></pre></div>
<p>But that doesn’t really answer our question. We want to look at the
number of frozen pixels per year, not the grand total for 20 years. To
generate a yearly summary we need a expression that does four
things:</p>
<ol style="list-style-type: lower-roman">
<li>loops over the years</li>
<li>pulls out the daily rasters for a specific year</li>
<li>sums up the number of frozen pixels</li>
<li>stores the results in a data frame</li>
</ol>
<p>First we get the years:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">tmin_allyrs_stars</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html" class="external-link">st_get_dimension_values</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">years_all</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 2045 2046 2047 2048 2049 2050 2051 2052 2053 2054 2055 2056 2057 2058 2059 2060 2061 2062 2063 2064 2065</span></span></code></pre></div>
<p>Now we can write a little loop that builds a data frame of the number
of frozen pixels per year:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">year_numfrost_df</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">yr</span> <span class="kw">in</span> <span class="va">years_all</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">year_numfrost_df</span> <span class="op">&lt;-</span> <span class="va">year_numfrost_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>year <span class="op">=</span> <span class="va">yr</span>,</span>
<span>                     num_frozen_pixels <span class="op">=</span> <span class="va">frost_allyrs_stars</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">==</span> <span class="va">yr</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>                       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">year_numfrost_df</span></span>
<span><span class="co">#&gt;    year num_frozen_pixels</span></span>
<span><span class="co">#&gt; 1  2045              1345</span></span>
<span><span class="co">#&gt; 2  2046               749</span></span>
<span><span class="co">#&gt; 3  2047              2134</span></span>
<span><span class="co">#&gt; 4  2048              3286</span></span>
<span><span class="co">#&gt; 5  2049               592</span></span>
<span><span class="co">#&gt; 6  2050               453</span></span>
<span><span class="co">#&gt; 7  2051              1291</span></span>
<span><span class="co">#&gt; 8  2052               538</span></span>
<span><span class="co">#&gt; 9  2053              1491</span></span>
<span><span class="co">#&gt; 10 2054              1966</span></span>
<span><span class="co">#&gt; 11 2055              2037</span></span>
<span><span class="co">#&gt; 12 2056              1424</span></span>
<span><span class="co">#&gt; 13 2057              1132</span></span>
<span><span class="co">#&gt; 14 2058              1473</span></span>
<span><span class="co">#&gt; 15 2059              1021</span></span>
<span><span class="co">#&gt; 16 2060              2121</span></span>
<span><span class="co">#&gt; 17 2061              1335</span></span>
<span><span class="co">#&gt; 18 2062               314</span></span>
<span><span class="co">#&gt; 19 2063               889</span></span>
<span><span class="co">#&gt; 20 2064               380</span></span>
<span><span class="co">#&gt; 21 2065               555</span></span></code></pre></div>
<p>A more compact way of doing this is:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">years_all</span>, <span class="kw">function</span><span class="op">(</span><span class="va">yr</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>year <span class="op">=</span> <span class="va">yr</span>,</span>
<span>             frost_pixel_days <span class="op">=</span> <span class="va">frost_allyrs_stars</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">==</span> <span class="va">yr</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>               <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    year frost_pixel_days</span></span>
<span><span class="co">#&gt; 1  2045             1345</span></span>
<span><span class="co">#&gt; 2  2046              749</span></span>
<span><span class="co">#&gt; 3  2047             2134</span></span>
<span><span class="co">#&gt; 4  2048             3286</span></span>
<span><span class="co">#&gt; 5  2049              592</span></span>
<span><span class="co">#&gt; 6  2050              453</span></span>
<span><span class="co">#&gt; 7  2051             1291</span></span>
<span><span class="co">#&gt; 8  2052              538</span></span>
<span><span class="co">#&gt; 9  2053             1491</span></span>
<span><span class="co">#&gt; 10 2054             1966</span></span>
<span><span class="co">#&gt; 11 2055             2037</span></span>
<span><span class="co">#&gt; 12 2056             1424</span></span>
<span><span class="co">#&gt; 13 2057             1132</span></span>
<span><span class="co">#&gt; 14 2058             1473</span></span>
<span><span class="co">#&gt; 15 2059             1021</span></span>
<span><span class="co">#&gt; 16 2060             2121</span></span>
<span><span class="co">#&gt; 17 2061             1335</span></span>
<span><span class="co">#&gt; 18 2062              314</span></span>
<span><span class="co">#&gt; 19 2063              889</span></span>
<span><span class="co">#&gt; 20 2064              380</span></span>
<span><span class="co">#&gt; 21 2065              555</span></span></code></pre></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Andy Lyons.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
