---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# caladaptr

<!-- badges: start -->
<!-- badges: end -->

`caladaptr` is an API client that makes it easier to work with data from Cal-Adapt.org in R.

## Installation

`caladaptr` is hosted on [GitHub](https://github.com/UCANR-IGIS/caladaptr){target="_blank" rel="noopener"}. To install it, you need to have [RTools](https://cran.r-project.org/bin/windows/Rtools/){target="_blank" rel="noopener"} installed.

```{r install_caladaptr, eval = FALSE}
library(devtools)
devtools::install_github("ucanr-igis/caladaptr")
```

# Example 1: Get Annual Projected Temperature at a Point Location

Load the package:

```{r load_package}
library(caladaptr)
```

First, create an API request object using a point location. This doesn't actually fetch any data, it puts together the pieces  pieces of an API request. There are a number of 'constructor' functions you can mix and match to create an API request object, for example:

```{r cap1_create, cache = TRUE}
cap1 <- ca_loc_pt(coords = c(-121.4687, 38.5938)) %>%
  ca_gcm(gcms[1:4]) %>%
  ca_scenario(scenarios[1:2]) %>%
  ca_period("year") %>%
  ca_years(start = 2040, end = 2060) %>%
  ca_cvar(c("tasmax", "tasmin"))

cap1
```

To help you pass arguments for the various constructor functions, the following constants are built-in:

```{r constants, cache = TRUE}
climvars

gcms

scenarios

periods

```

**Note**: Cal-Adapt has data for many but by no means all permutations of the above constants.

Next, feed your API call into a function that fetches data, such as `ca_getvals()`. 

```{r cap1_getvals, cache = TRUE}
cap1_vals_df <- ca_getvals(cap1, quiet = TRUE) %>% ca_vals2tbl()
dim(cap1_vals_df)
head(cap1_vals_df)
```

Note: values are returned with units, thanks to the [units](https://cran.r-project.org/package=units) package. No more guessing what the units are, or having to lookup unit conversion constants!

# Example #2: Same as #1, but with a Congressional District

Cal-Adapt supports ~10 'preset' Areas of Interest. `caladaptr` refers to these as "AOI Presets', and you can use them to specify area(s) of interest in your API requests:

```{r}
aoipreset_types
```

Next, we'll modify the first API call by simply "swapping out" the point location for a Congressional District location, using the `ca_loc_aoipreset()` function. For this example we'll use California's 20th and 24th [Congressional Districts](https://en.wikipedia.org/wiki/California%27s_congressional_districts) (Carmel Valley and Santa Barbara). 

```{r cap2_define, cache=TRUE}
cap2 <- cap1 %>% ca_loc_aoipreset(type = "cdistricts",
                                  idfld = "geoid",
                                  idval = c("0620", "0624"),
                                  stat = "mean")

cap2
```

Note when you query a polygon, you have to also specify a summary statistic that will be used to reduce the various pixels that fall within the polygon to one number. Your choices are `mean`, `max`, `median`, `min`, and `sum.` (If you want to retain the individual pixel values, use `ca_getrst()`.)

```{r ca2_getvals, cache=TRUE}
cap2_vals_df <- ca_getvals(cap2, quiet = TRUE) %>% ca_vals2tbl()

dim(cap2_vals_df)
head(cap2_vals_df)
```

# Coming soon...

Querying a sf object

Examples of reshaping data

Retrieving rasters

